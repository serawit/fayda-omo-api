{"version":3,"file":"server.js","sourceRoot":"","sources":["../src/server.ts"],"names":[],"mappings":"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","sourcesContent":["import express, { Request, Response } from 'express';\r\nimport cors from 'cors';\r\nimport helmet from 'helmet';\r\nimport dotenv from 'dotenv';\r\nimport rateLimit from 'express-rate-limit';\r\nimport session from 'express-session';\r\nimport MongoStore from 'connect-mongo';\r\nimport mongoose from 'mongoose';\r\nimport authRoutes from './routes/auth.routes.js'; // Note the .js extension for ESM/TSX\r\nimport harmonizationRoutes from './routes/harmonization.routes.js';\r\nimport userRoutes from './routes/user.routes.js';\r\nimport { handleCallback } from './controllers/auth.controller.js';\r\nimport dashboardRoutes from './routes/dashboard.routes.js';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\n\r\n// Load environment variables\r\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\r\ndotenv.config({ path: path.resolve(__dirname, '../.env') });\r\n\r\nconst app = express();\r\nconst PORT = process.env.PORT || 5000;\r\napp.set('trust proxy', 1); // Trust Nginx to handle HTTPS/SSL\r\n\r\n// Middleware\r\napp.use(helmet({\r\n  crossOriginOpenerPolicy: false, // Disable COOP to allow HTTP/LAN access without warnings\r\n}));\r\napp.use(cors({\r\n  origin: [\r\n    process.env.FRONTEND_URL,\r\n    'https://fayda.omobanksc.com',\r\n    'http://10.11.0.59:3000',\r\n    'http://10.11.0.59:5173',\r\n    'http://localhost:3000',\r\n    'http://localhost:5173'\r\n  ].filter((origin): origin is string => !!origin),\r\n  credentials: true // Important for sessions/cookies\r\n}));\r\napp.use(express.json());\r\napp.use(rateLimit({  // Basic DoS protection\r\n  windowMs: 15 * 60 * 1000,  // 15 min\r\n  max: 1000  // Increased limit for development\r\n}));\r\napp.use(express.urlencoded({ extended: true }));\r\n\r\n// Database Connection String\r\nconst mongoUri = process.env.MONGO_URI || process.env.DB_URI || 'mongodb://127.0.0.1:27017/fayda-omo';\r\n\r\n// Session Configuration\r\napp.use(session({\r\n  secret: process.env.JWT_SECRET || 'fallback-secret-key-change-in-prod',\r\n  resave: false,\r\n  saveUninitialized: false,\r\n  store: MongoStore.create({\r\n    mongoUrl: mongoUri,\r\n    collectionName: 'sessions', // Optional: defaults to 'sessions'\r\n    ttl: 14 * 24 * 60 * 60 // Optional: Session expiration in seconds (14 days)\r\n  }),\r\n  cookie: {\r\n    secure: process.env.NODE_ENV === 'production', // Set to true in production for HTTPS\r\n    httpOnly: true,\r\n    maxAge: 1000 * 60 * 15, // 15 minutes\r\n  }\r\n}));\r\n\r\n// Database Connection\r\nmongoose.connect(mongoUri)\r\n  .then(() => console.log('âœ… Connected to MongoDB'))\r\n  .catch((err) => console.error('âŒ MongoDB connection error:', err));\r\n\r\n// Routes\r\napp.use('/api/auth', authRoutes);\r\napp.use('/api/harmonization', harmonizationRoutes);\r\napp.use('/api/user', userRoutes);\r\napp.use('/api/dashboard', dashboardRoutes);\r\n\r\n// Handle the production callback URL specifically (outside /api/auth prefix)\r\napp.get('/auth/fayda/callback', handleCallback);\r\n\r\n// Test route\r\napp.get('/', (req: Request, res: Response) => {\r\n  res.json({ message: 'Fayda-Omo API backend rebuilt from scratch! ðŸš€' });\r\n});\r\n\r\nconst server = app.listen(PORT, '0.0.0.0', () => {\r\n  console.log(`ðŸš€ Server listening on port ${PORT}.`);\r\n  if (process.env.NODE_ENV === 'production') {\r\n    console.log(`   Public URL: https://fayda.omobanksc.com`);\r\n  }\r\n  console.log(`   Local URL:  http://localhost:${PORT} or your LAN IP.`);\r\n  console.log(`(Time in Addis Ababa: ${new Date().toLocaleString('en-US', { timeZone: 'Africa/Addis_Ababa' })})`);\r\n});\r\n\r\n// Graceful Shutdown: Close DB connection properly when server stops\r\nconst gracefulShutdown = (signal: string) => {\r\n  console.log(`\\n${signal} signal received. Closing HTTP server...`);\r\n  server.close(() => {\r\n    console.log('HTTP server closed.');\r\n    mongoose.connection.close(false).then(() => {\r\n      console.log('MongoDB connection closed. Exiting.');\r\n      process.exit(0);\r\n    });\r\n  });\r\n};\r\n\r\nprocess.on('SIGTERM', () => gracefulShutdown('SIGTERM'));\r\nprocess.on('SIGINT', () => gracefulShutdown('SIGINT'));"]}