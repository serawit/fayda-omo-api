{"version":3,"file":"auth.controller.js","sourceRoot":"","sources":["../../src/controllers/auth.controller.ts"],"names":[],"mappings":"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","sourcesContent":["// src/controllers/auth.controller.ts\r\nimport { Request, Response } from 'express';\r\nimport axios from 'axios';\r\nimport * as jose from 'jose';\r\nimport crypto from 'crypto';\r\nimport { z } from 'zod';\r\nimport FaydaCustomer from '../models/CustomerFayda.js';\r\nimport { sendSms } from '../services/sms.service.js';\r\nimport { SmsTemplates } from '../utils/smsTemplates.js';\r\nimport { generateCodeVerifier, generateCodeChallenge } from '../utils/pkce.js';\r\nimport { lookupCoreBankingCustomer } from '../services/coreBanking.service.js';\r\n\r\n// ────────────────────────────────────────────────\r\n// Config (from .env)\r\n// ────────────────────────────────────────────────\r\n\r\nconst FAYDA_AUTH_URL = process.env.FAYDA_BASE_URL || 'https://auth.fayda.et';\r\n\r\nconst REDIRECT_URI =\r\n  'https://fayda.omobanksc.com/auth/fayda/callback';\r\n\r\nconst FRONTEND_URL =\r\n  process.env.FRONTEND_URL || 'http://10.11.0.59:3000';\r\n\r\n// ────────────────────────────────────────────────\r\n// Schemas\r\n// ────────────────────────────────────────────────\r\n\r\nconst initiateSchema = z.object({\r\n  accountNumber: z.string()\r\n    .min(8, 'Account number must be at least 8 digits')\r\n    .max(30, 'Account number must be at most 30 digits')\r\n    .regex(/^\\d+$/, 'Account number must contain only digits')\r\n    .trim(),\r\n});\r\n\r\nconst otpVerifySchema = z.object({\r\n  otp: z.string().length(6, 'OTP must be exactly 6 digits'),\r\n});\r\n\r\nconst fanSchema = z.string().regex(/^\\d{16}$/, 'Fayda ID must be exactly 16 digits');\r\n\r\n// ────────────────────────────────────────────────\r\n// Session extension\r\n// ────────────────────────────────────────────────\r\n\r\ndeclare module 'express-session' {\r\n  interface SessionData {\r\n    accountNumber?: string;\r\n    otp?: string;\r\n    otpCreatedAt?: number;\r\n    otpAttempts?: number;\r\n    otpVerified?: boolean;\r\n    codeVerifier?: string;\r\n    state?: string;\r\n    faydaNumber?: string;\r\n  }\r\n}\r\n\r\n// ────────────────────────────────────────────────\r\n// Helpers\r\n// ────────────────────────────────────────────────\r\n\r\nfunction generateOtp(): string {\r\n  return crypto.randomInt(100000, 999999).toString();\r\n}\r\n\r\nfunction isOtpExpired(createdAt?: number): boolean {\r\n  if (!createdAt) return true;\r\n  return Date.now() - createdAt > 10 * 60 * 1000; // 10 minutes\r\n}\r\n\r\n// ────────────────────────────────────────────────\r\n// 1. Initiate login – send OTP\r\n// ────────────────────────────────────────────────\r\n\r\nexport const initiateBankLogin = async (req: Request, res: Response) => {\r\n  try {\r\n    const { accountNumber } = initiateSchema.parse(req.body);\r\n\r\n    // ────────────────────────────────────────────────\r\n    // 6. Fallback/Demo Login for testing\r\n    // ────────────────────────────────────────────────\r\n    if (accountNumber === '12345678') {\r\n      req.session.accountNumber = accountNumber;\r\n      req.session.otp = '111111'; // Fixed OTP for UAT\r\n      req.session.otpCreatedAt = Date.now();\r\n      req.session.otpAttempts = 0;\r\n      req.session.otpVerified = false;\r\n      await req.session.save();\r\n\r\n      return res.status(200).json({\r\n        success: true,\r\n        message: 'Demo Mode: Use OTP 111111',\r\n        maskedPhone: '+2519****0000',\r\n      });\r\n    }\r\n\r\n    // Real core banking lookup (Mocked)\r\n    const coreCustomer = await lookupCoreBankingCustomer(accountNumber);\r\n\r\n    if (!coreCustomer) {\r\n      return res.status(404).json({ success: false, message: 'Account not found in Core Banking records.' });\r\n    }\r\n\r\n    if (coreCustomer.status !== 'ACTIVE') {\r\n      return res.status(403).json({ success: false, message: 'Account is not active.' });\r\n    }\r\n\r\n    const phoneNumber = coreCustomer.phoneNumber;\r\n\r\n    const otp = generateOtp();\r\n    const message = SmsTemplates.otp(otp);\r\n\r\n    await sendSms(phoneNumber, message);\r\n\r\n    req.session.accountNumber = accountNumber;\r\n    req.session.otp = otp;\r\n    req.session.otpCreatedAt = Date.now();\r\n    req.session.otpAttempts = 0;\r\n    req.session.otpVerified = false;\r\n\r\n    await req.session.save();\r\n\r\n    const masked = phoneNumber.replace(/\\d(?=\\d{4})/g, '*');\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: 'OTP sent successfully',\r\n      maskedPhone: masked,\r\n    });\r\n  } catch (err) {\r\n    if (err instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, errors: err.issues });\r\n    }\r\n    console.error('initiateBankLogin error:', err);\r\n    res.status(500).json({ success: false, message: 'Internal server error' });\r\n  }\r\n};\r\n\r\n// ────────────────────────────────────────────────\r\n// 2. Verify OTP\r\n// ────────────────────────────────────────────────\r\n\r\nexport const verifyBankOtp = async (req: Request, res: Response) => {\r\n  try {\r\n    const { otp } = otpVerifySchema.parse(req.body);\r\n\r\n    if (!req.session.accountNumber || !req.session.otp || !req.session.otpCreatedAt) {\r\n      return res.status(400).json({ success: false, message: 'Session expired. Start again.' });\r\n    }\r\n\r\n    if (isOtpExpired(req.session.otpCreatedAt)) {\r\n      return res.status(410).json({ success: false, message: 'OTP expired. Request new one.' });\r\n    }\r\n\r\n    req.session.otpAttempts = (req.session.otpAttempts || 0) + 1;\r\n\r\n    if (req.session.otpAttempts > 4) {\r\n      return res.status(429).json({ success: false, message: 'Too many attempts. Request new OTP.' });\r\n    }\r\n\r\n    if (req.session.otp !== otp) {\r\n      await req.session.save();\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Invalid OTP',\r\n        attemptsLeft: 4 - req.session.otpAttempts,\r\n      });\r\n    }\r\n\r\n    req.session.otpVerified = true;\r\n    req.session.otp = undefined;\r\n    req.session.otpCreatedAt = undefined;\r\n    req.session.otpAttempts = 0;\r\n\r\n    await req.session.save();\r\n\r\n    // ────────────────────────────────────────────────\r\n    // Auto-generate Fayda Consent URL (Redirect immediately)\r\n    // ────────────────────────────────────────────────\r\n    const codeVerifier = generateCodeVerifier();\r\n    const codeChallenge = generateCodeChallenge(codeVerifier);\r\n    const state = crypto.randomBytes(16).toString('hex');\r\n\r\n    req.session.codeVerifier = codeVerifier;\r\n    req.session.state = state;\r\n    await req.session.save();\r\n\r\n    const authUrl = new URL(`${FAYDA_AUTH_URL}/authorize`);\r\n    authUrl.searchParams.set('response_type', 'code');\r\n    authUrl.searchParams.set('client_id', process.env.FAYDA_CLIENT_ID!);\r\n    authUrl.searchParams.set('redirect_uri', REDIRECT_URI);\r\n    authUrl.searchParams.set('scope', 'openid profile phone email address birthdate nationality gender picture');\r\n    authUrl.searchParams.set('state', state);\r\n    authUrl.searchParams.set('code_challenge', codeChallenge);\r\n    authUrl.searchParams.set('code_challenge_method', 'S256');\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: 'OTP verified',\r\n      redirectUrl: authUrl.toString(),\r\n    });\r\n  } catch (err) {\r\n    if (err instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, errors: err.issues });\r\n    }\r\n    console.error('verifyBankOtp error:', err);\r\n    res.status(500).json({ success: false, message: 'Internal server error' });\r\n  }\r\n};\r\n\r\n// ────────────────────────────────────────────────\r\n// 3. Session status\r\n// ────────────────────────────────────────────────\r\n\r\nexport const getSessionStatus = async (req: Request, res: Response) => {\r\n  try {\r\n    if (req.session?.otpVerified && req.session?.accountNumber) {\r\n      // 5. Display verified user data (Fetch from DB)\r\n      const user = await FaydaCustomer.findOne({ accountNumber: req.session.accountNumber });\r\n\r\n      return res.status(200).json({\r\n        success: true,\r\n        isAuthenticated: true,\r\n        accountNumber: req.session.accountNumber,\r\n        user, // Return profile data to frontend\r\n      });\r\n    }\r\n\r\n    res.status(403).json({\r\n      success: false,\r\n      isAuthenticated: false,\r\n      message: 'Session invalid or expired.',\r\n    });\r\n  } catch (err) {\r\n    console.error('getSessionStatus error:', err);\r\n    res.status(500).json({ success: false, message: 'Server error' });\r\n  }\r\n};\r\n\r\n// ────────────────────────────────────────────────\r\n// 4. Initiate Fayda consent (OIDC + PKCE)\r\n// ────────────────────────────────────────────────\r\n\r\nexport const initiateConsent = async (req: Request, res: Response) => {\r\n  try {\r\n    if (!req.session.otpVerified || !req.session.accountNumber) {\r\n      return res.status(403).json({ success: false, message: 'OTP verification required' });\r\n    }\r\n\r\n    const codeVerifier = generateCodeVerifier();\r\n    const codeChallenge = generateCodeChallenge(codeVerifier);\r\n    const state = crypto.randomBytes(16).toString('hex');\r\n\r\n    req.session.codeVerifier = codeVerifier;\r\n    req.session.state = state;\r\n\r\n    await req.session.save();\r\n\r\n    const authUrl = new URL(`${FAYDA_AUTH_URL}/authorize`);\r\n    authUrl.searchParams.set('response_type', 'code');\r\n    authUrl.searchParams.set('client_id', process.env.FAYDA_CLIENT_ID!);\r\n    authUrl.searchParams.set('redirect_uri', REDIRECT_URI);\r\n    authUrl.searchParams.set(\r\n      'scope',\r\n      'openid profile phone email address birthdate nationality gender picture'\r\n    );\r\n    authUrl.searchParams.set('state', state);\r\n    authUrl.searchParams.set('code_challenge', codeChallenge);\r\n    authUrl.searchParams.set('code_challenge_method', 'S256');\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      consentUrl: authUrl.toString(),\r\n    });\r\n  } catch (err) {\r\n    console.error('initiateConsent error:', err);\r\n    res.status(500).json({ success: false, message: 'Failed to start consent' });\r\n  }\r\n};\r\n\r\n// ────────────────────────────────────────────────\r\n// 5. Handle Fayda callback\r\n// ────────────────────────────────────────────────\r\n\r\nexport const handleCallback = async (req: Request, res: Response) => {\r\n  const { code, state, error } = req.query as { code?: string; state?: string; error?: string };\r\n\r\n  if (error) {\r\n    return res.redirect(`${FRONTEND_URL}/error?reason=consent_denied`);\r\n  }\r\n\r\n  if (!state || state !== req.session?.state) {\r\n    return res.redirect(`${FRONTEND_URL}/error?reason=invalid_state`);\r\n  }\r\n\r\n  if (!req.session.codeVerifier || !req.session.accountNumber) {\r\n    return res.redirect(`${FRONTEND_URL}/error?reason=session_invalid`);\r\n  }\r\n\r\n  try {\r\n    const tokenResponse = await axios.post(\r\n      `${FAYDA_AUTH_URL}/token`,\r\n      new URLSearchParams({\r\n        grant_type: 'authorization_code',\r\n        code: code as string,\r\n        redirect_uri: REDIRECT_URI,\r\n        client_id: process.env.FAYDA_CLIENT_ID!,\r\n        client_secret: process.env.FAYDA_CLIENT_SECRET!,\r\n        code_verifier: req.session.codeVerifier,\r\n      }),\r\n      { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } }\r\n    );\r\n\r\n    const { id_token } = tokenResponse.data;\r\n\r\n    const JWKS = jose.createRemoteJWKSet(new URL(`${FAYDA_AUTH_URL}/.well-known/jwks.json`));\r\n    const { payload } = await jose.jwtVerify(id_token, JWKS, {\r\n      issuer: FAYDA_AUTH_URL,\r\n      audience: process.env.FAYDA_CLIENT_ID!,\r\n    });\r\n\r\n    const accountNumber = req.session.accountNumber;\r\n\r\n    await FaydaCustomer.findOneAndUpdate(\r\n      { accountNumber },\r\n      {\r\n        faydaNumber: payload.fin as string,\r\n        fullName: `${payload.given_name || ''} ${payload.family_name || ''}`.trim(),\r\n        phoneNumber: payload.phone_number as string,\r\n        gender: (payload.gender as string)?.toUpperCase(),\r\n        dob: payload.birthdate ? new Date(payload.birthdate as string) : undefined,\r\n        address: (payload.address as any)?.formatted ?? '',\r\n        photoUrl: payload.picture as string,\r\n        email: payload.email as string,\r\n        nationality: 'ET',\r\n        status: 'active',\r\n        isHarmonized: true,\r\n        harmonizedAt: new Date(),\r\n      },\r\n      { upsert: true, new: true }\r\n    );\r\n\r\n    req.session.codeVerifier = undefined;\r\n    req.session.state = undefined;\r\n    req.session.otpVerified = undefined;\r\n\r\n    await req.session.save();\r\n\r\n    res.redirect(`${FRONTEND_URL}/dashboard?status=verification_complete`);\r\n  } catch (err: any) {\r\n    console.error('handleCallback error:', err.message, err.response?.data);\r\n    res.redirect(`${FRONTEND_URL}/error?reason=server_error`);\r\n  }\r\n};"]}