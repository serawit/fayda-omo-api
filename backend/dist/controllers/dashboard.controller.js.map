{"version":3,"file":"dashboard.controller.js","sourceRoot":"","sources":["../../src/controllers/dashboard.controller.ts"],"names":[],"mappings":"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","sourcesContent":["// controllers/dashboard.controller.ts\r\nimport { Request, Response } from 'express';\r\nimport { Types } from 'mongoose';\r\nimport HarmonizationLog from '../models/HarmonizationLog.js'; // ← assume you have this model\r\n// import logger from '../config/logger'; // optional - use console for now\r\n\r\ninterface DashboardStats {\r\n  total: number | string;\r\n  pending: number;\r\n  successRate: string;\r\n}\r\n\r\ninterface LogEntry {\r\n  id: number | string;\r\n  user: string;\r\n  status: 'Successful' | 'Pending' | 'Failed';\r\n  timestamp: string;\r\n}\r\n\r\n/**\r\n * GET /api/dashboard\r\n * Returns aggregated harmonization statistics and recent logs\r\n * Query params (optional):\r\n * - range: 'today' | 'week' | 'month' | 'all' (default: 'week')\r\n * - limit: number (default: 50)\r\n */\r\nexport const getDashboardData = async (req: Request, res: Response) => {\r\n  try {\r\n    const { range = 'week', limit = '50' } = req.query;\r\n    const limitNum = Math.min(Math.max(10, parseInt(limit as string, 10)), 200);\r\n\r\n    // ────────────────────────────────────────────────\r\n    // 1. Date range filter\r\n    // ────────────────────────────────────────────────\r\n    let startDate: Date | undefined;\r\n    const now = new Date();\r\n\r\n    if (range === 'today') {\r\n      startDate = new Date(now.setHours(0, 0, 0, 0));\r\n    } else if (range === 'week') {\r\n      startDate = new Date(now);\r\n      startDate.setDate(now.getDate() - 7);\r\n    } else if (range === 'month') {\r\n      startDate = new Date(now.getFullYear(), now.getMonth(), 1);\r\n    }\r\n\r\n    // ────────────────────────────────────────────────\r\n    // 2. Real aggregation (Mongoose example)\r\n    // ────────────────────────────────────────────────\r\n    const matchStage: any = startDate ? { createdAt: { $gte: startDate } } : {};\r\n\r\n    const statsPipeline = [\r\n      { $match: matchStage },\r\n      {\r\n        $group: {\r\n          _id: null,\r\n          total: { $sum: 1 },\r\n          pending: { $sum: { $cond: [{ $eq: ['$status', 'Pending'] }, 1, 0] } },\r\n          success: { $sum: { $cond: [{ $eq: ['$status', 'Successful'] }, 1, 0] } },\r\n        },\r\n      },\r\n      {\r\n        $project: {\r\n          total: 1,\r\n          pending: 1,\r\n          successRate: {\r\n            $cond: [\r\n              { $eq: ['$total', 0] },\r\n              '0%',\r\n              { $concat: [{ $toString: { $multiply: [{ $divide: ['$success', '$total'] }, 100] } }, '%'] },\r\n            ],\r\n          },\r\n        },\r\n      },\r\n    ];\r\n\r\n    const statsResult = await HarmonizationLog.aggregate(statsPipeline);\r\n\r\n    const stats: DashboardStats = statsResult[0] || {\r\n      total: 0,\r\n      pending: 0,\r\n      successRate: '0%',\r\n    };\r\n\r\n    // Format total as string with comma separator (frontend friendly)\r\n    stats.total = stats.total.toLocaleString();\r\n\r\n    // ────────────────────────────────────────────────\r\n    // 3. Recent logs (last 7 days or filtered range)\r\n    // ────────────────────────────────────────────────\r\n    const recentLogs = await HarmonizationLog.find(matchStage)\r\n      .sort({ createdAt: -1 })\r\n      .limit(limitNum)\r\n      .select('user fullName status createdAt')\r\n      .lean();\r\n\r\n    // Group logs by day of week (for frontend chart)\r\n    const logsByDay: Record<string, LogEntry[]> = {\r\n      Mon: [], Tue: [], Wed: [], Thu: [], Fri: [], Sat: [], Sun: [],\r\n    };\r\n\r\n    recentLogs.forEach((log: any) => {\r\n      const date = new Date(log.createdAt);\r\n      const dayName = date.toLocaleString('en-US', { weekday: 'short' });\r\n      const timestamp = date.toLocaleString('en-US', {\r\n        year: 'numeric',\r\n        month: 'short',\r\n        day: 'numeric',\r\n        hour: '2-digit',\r\n        minute: '2-digit',\r\n      });\r\n\r\n      logsByDay[dayName as keyof typeof logsByDay].push({\r\n        id: log._id.toString(),\r\n        user: log.fullName || log.user || 'Unknown',\r\n        status: log.status,\r\n        timestamp,\r\n      });\r\n    });\r\n\r\n    // ────────────────────────────────────────────────\r\n    // 4. Response\r\n    // ────────────────────────────────────────────────\r\n    return res.status(200).json({\r\n      success: true,\r\n      stats,\r\n      logs: logsByDay,\r\n      meta: {\r\n        range,\r\n        returned: recentLogs.length,\r\n        limit: limitNum,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error('getDashboardData failed:', {\r\n      message: error.message,\r\n      stack: error.stack,\r\n    });\r\n\r\n    return res.status(500).json({\r\n      success: false,\r\n      message: 'Failed to fetch dashboard data',\r\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined,\r\n    });\r\n  }\r\n};"]}