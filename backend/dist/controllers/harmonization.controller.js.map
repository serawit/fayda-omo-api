{"version":3,"file":"harmonization.controller.js","sourceRoot":"","sources":["../../src/controllers/harmonization.controller.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,CAAC,EAAE,MAAM,KAAK,CAAC;AACxB,OAAO,aAAa,MAAM,4BAA4B,CAAC;AAMvD,MAAM,SAAS,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC,KAAK,CAAC,UAAU,EAAE,oCAAoC,CAAC,CAAC;AAErF,MAAM,eAAe,GAAG,CAAC,CAAC,MAAM,CAAC;IAC/B,GAAG,EAAE,SAAS;IACd,GAAG,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,MAAM,CAAC,CAAC,EAAE,sBAAsB,CAAC;CAClD,CAAC,CAAC;AAEH,MAAM,gBAAgB,GAAG,CAAC,CAAC,MAAM,CAAC;IAChC,GAAG,EAAE,SAAS;IACd,SAAS,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,GAAG,EAAE,oBAAoB,CAAC;IACpD,QAAQ,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC,CAAC,QAAQ,EAAE;CACzC,CAAC,CAAC;AAEH,MAAM,kBAAkB,GAAG,CAAC,CAAC,MAAM,CAAC;IAClC,GAAG,EAAE,SAAS;IACd,QAAQ,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,+BAA+B,CAAC;CACtE,CAAC,CAAC;AAMH,MAAM,CAAC,MAAM,WAAW,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IAC/D,IAAI,CAAC;QACH,MAAM,EAAE,GAAG,EAAE,GAAG,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QAIpE,MAAM,OAAO,GAAG,GAAG,CAAC,MAAM,KAAK,EAAE,IAAI,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAEvD,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,kBAAkB,EAAE,CAAC,CAAC;QAC/E,CAAC;QAED,IAAI,GAAG,CAAC,OAAO,EAAE,CAAC;YAChB,GAAG,CAAC,OAAO,CAAC,WAAW,GAAG,GAAG,CAAC;YAC9B,MAAM,GAAG,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;QAC3B,CAAC;QAED,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;YACnB,OAAO,EAAE,IAAI;YACb,KAAK,EAAE,IAAI;YACX,OAAO,EAAE,oBAAoB;SAC9B,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,IAAI,GAAG,YAAY,CAAC,CAAC,QAAQ,EAAE,CAAC;YAC9B,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,CAAC;QACtE,CAAC;QACD,OAAO,CAAC,KAAK,CAAC,oBAAoB,EAAE,GAAG,CAAC,CAAC;QACzC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,cAAc,EAAE,CAAC,CAAC;IACpE,CAAC;AACH,CAAC,CAAC;AAMF,MAAM,CAAC,MAAM,OAAO,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IAC3D,IAAI,CAAC;QACH,MAAM,EAAE,GAAG,EAAE,GAAG,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QAG1C,MAAM,WAAW,GAAG,eAAe,CAAC;QAEpC,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,MAAM,CAAC,CAAC,QAAQ,EAAE,CAAC;QAGnE,IAAI,GAAG,CAAC,OAAO,EAAE,CAAC;YAChB,GAAG,CAAC,OAAO,CAAC,GAAG,GAAG,GAAG,CAAC;YACtB,GAAG,CAAC,OAAO,CAAC,YAAY,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YACtC,MAAM,GAAG,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;QAC3B,CAAC;QAGD,OAAO,CAAC,GAAG,CAAC,cAAc,GAAG,aAAa,WAAW,WAAW,GAAG,EAAE,CAAC,CAAC;QAEvE,MAAM,MAAM,GAAG,WAAW,CAAC,OAAO,CAAC,cAAc,EAAE,GAAG,CAAC,CAAC;QAExD,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;YACnB,OAAO,EAAE,IAAI;YACb,OAAO,EAAE,UAAU;YACnB,WAAW,EAAE,MAAM;SACpB,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,IAAI,GAAG,YAAY,CAAC,CAAC,QAAQ,EAAE,CAAC;YAC9B,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,CAAC;QACtE,CAAC;QACD,OAAO,CAAC,KAAK,CAAC,gBAAgB,EAAE,GAAG,CAAC,CAAC;QACrC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,oBAAoB,EAAE,CAAC,CAAC;IAC1E,CAAC;AACH,CAAC,CAAC;AAMF,MAAM,CAAC,MAAM,SAAS,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IAC7D,IAAI,CAAC;QACH,MAAM,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,eAAe,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QAErD,IAAI,CAAC,GAAG,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,OAAO,EAAE,YAAY,EAAE,CAAC;YACpD,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,sBAAsB,EAAE,CAAC,CAAC;QACnF,CAAC;QAED,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,GAAG,CAAC,OAAO,CAAC,YAAY,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,EAAE,CAAC;YAC3D,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,aAAa,EAAE,CAAC,CAAC;QAC1E,CAAC;QAED,IAAI,GAAG,CAAC,OAAO,CAAC,GAAG,KAAK,GAAG,EAAE,CAAC;YAC5B,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,aAAa,EAAE,CAAC,CAAC;QAC1E,CAAC;QAGD,GAAG,CAAC,OAAO,CAAC,GAAG,GAAG,SAAS,CAAC;QAC5B,GAAG,CAAC,OAAO,CAAC,YAAY,GAAG,SAAS,CAAC;QAErC,MAAM,aAAa,CAAC,gBAAgB,CAClC,EAAE,GAAG,EAAE,EACP,EAAE,GAAG,EAAE,MAAM,EAAE,KAAK,EAAE,MAAM,EAAE,UAAU,EAAE,UAAU,EAAE,IAAI,IAAI,EAAE,EAAE,EAClE,EAAE,MAAM,EAAE,IAAI,EAAE,CACjB,CAAC;QAEF,MAAM,GAAG,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;QAEzB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,cAAc,EAAE,CAAC,CAAC;IACnE,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,IAAI,GAAG,YAAY,CAAC,CAAC,QAAQ,EAAE,CAAC;YAC9B,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,CAAC;QACtE,CAAC;QACD,OAAO,CAAC,KAAK,CAAC,kBAAkB,EAAE,GAAG,CAAC,CAAC;QACvC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,cAAc,EAAE,CAAC,CAAC;IACpE,CAAC;AACH,CAAC,CAAC;AAMF,MAAM,CAAC,MAAM,UAAU,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IAC9D,IAAI,CAAC;QACH,MAAM,EAAE,GAAG,EAAE,SAAS,EAAE,QAAQ,EAAE,GAAG,gBAAgB,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QAGtE,MAAM,UAAU,GAAG,IAAI,CAAC;QAExB,IAAI,UAAU,GAAG,IAAI,EAAE,CAAC;YACtB,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBAC1B,OAAO,EAAE,KAAK;gBACd,OAAO,EAAE,4CAA4C;gBACrD,UAAU;aACX,CAAC,CAAC;QACL,CAAC;QAED,MAAM,aAAa,CAAC,gBAAgB,CAClC,EAAE,GAAG,EAAE,EACP;YACE,GAAG;YACH,MAAM,EAAE,MAAM;YACd,MAAM,EAAE,UAAU;YAClB,UAAU,EAAE,IAAI,IAAI,EAAE;YACtB,QAAQ,EAAE,QAAQ,IAAI,EAAE;YACxB,UAAU;SACX,EACD,EAAE,MAAM,EAAE,IAAI,EAAE,CACjB,CAAC;QAEF,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;YACnB,OAAO,EAAE,IAAI;YACb,OAAO,EAAE,eAAe;YACxB,UAAU;SACX,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,IAAI,GAAG,YAAY,CAAC,CAAC,QAAQ,EAAE,CAAC;YAC9B,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,CAAC;QACtE,CAAC;QACD,OAAO,CAAC,KAAK,CAAC,mBAAmB,EAAE,GAAG,CAAC,CAAC;QACxC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,cAAc,EAAE,CAAC,CAAC;IACpE,CAAC;AACH,CAAC,CAAC;AAMF,MAAM,CAAC,MAAM,YAAY,GAAG,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IAChE,IAAI,CAAC;QACH,MAAM,EAAE,GAAG,EAAE,QAAQ,EAAE,GAAG,kBAAkB,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QAE7D,IAAI,CAAC,GAAG,CAAC,OAAO,EAAE,aAAa,EAAE,CAAC;YAChC,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,iBAAiB,EAAE,CAAC,CAAC;QAC9E,CAAC;QAED,MAAM,aAAa,GAAG,GAAG,CAAC,OAAO,CAAC,aAAa,CAAC;QAEhD,MAAM,aAAa,CAAC,gBAAgB,CAClC,EAAE,GAAG,EAAE,EACP;YACE,MAAM,EAAE,WAAW;YACnB,QAAQ;YACR,YAAY,EAAE,IAAI,IAAI,EAAE;SACzB,EACD,EAAE,MAAM,EAAE,IAAI,EAAE,CACjB,CAAC;QAKF,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;YACnB,OAAO,EAAE,IAAI;YACb,OAAO,EAAE,8BAA8B;SACxC,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,IAAI,GAAG,YAAY,CAAC,CAAC,QAAQ,EAAE,CAAC;YAC9B,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,CAAC;QACtE,CAAC;QACD,OAAO,CAAC,KAAK,CAAC,qBAAqB,EAAE,GAAG,CAAC,CAAC;QAC1C,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,cAAc,EAAE,CAAC,CAAC;IACpE,CAAC;AACH,CAAC,CAAC","sourcesContent":["// src/controllers/harmonization.controller.ts\r\nimport { Request, Response } from 'express';\r\nimport { z } from 'zod';\r\nimport Harmonization from '../models/Harmonization.js';\r\n\r\n// ────────────────────────────────────────────────\r\n// Schemas\r\n// ────────────────────────────────────────────────\r\n\r\nconst fanSchema = z.string().regex(/^\\d{16}$/, 'Fayda ID must be exactly 16 digits');\r\n\r\nconst otpVerifySchema = z.object({\r\n  fan: fanSchema,\r\n  otp: z.string().length(6, 'OTP must be 6 digits'),\r\n});\r\n\r\nconst faceVerifySchema = z.object({\r\n  fan: fanSchema,\r\n  faceImage: z.string().min(100, 'Invalid face image'),\r\n  accounts: z.array(z.string()).optional(),\r\n});\r\n\r\nconst linkAccountsSchema = z.object({\r\n  fan: fanSchema,\r\n  accounts: z.array(z.string()).min(1, 'At least one account required'),\r\n});\r\n\r\n// ────────────────────────────────────────────────\r\n// 1. Validate Fayda ID (FAN)\r\n// ────────────────────────────────────────────────\r\n\r\nexport const validateFan = async (req: Request, res: Response) => {\r\n  try {\r\n    const { fan } = fanSchema.parse(req.body.fan ? req.body : req.body); // support both {fan} or {faydaNumber}\r\n\r\n    // TODO: Real Fayda/NIDP validation (client credentials flow)\r\n    // For now: mock success\r\n    const isValid = fan.length === 16 && /^\\d+$/.test(fan);\r\n\r\n    if (!isValid) {\r\n      return res.status(400).json({ success: false, message: 'Invalid Fayda ID' });\r\n    }\r\n\r\n    if (req.session) {\r\n      req.session.faydaNumber = fan;\r\n      await req.session.save();\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      valid: true,\r\n      message: 'Fayda ID validated',\r\n    });\r\n  } catch (err) {\r\n    if (err instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, errors: err.issues });\r\n    }\r\n    console.error('validateFan error:', err);\r\n    res.status(500).json({ success: false, message: 'Server error' });\r\n  }\r\n};\r\n\r\n// ────────────────────────────────────────────────\r\n// 2. Send OTP to Fayda-linked phone\r\n// ────────────────────────────────────────────────\r\n\r\nexport const sendOtp = async (req: Request, res: Response) => {\r\n  try {\r\n    const { fan } = fanSchema.parse(req.body);\r\n\r\n    // TODO: Fetch real phone from Fayda or DB\r\n    const phoneNumber = '+251911234567'; // ← REPLACE\r\n\r\n    const otp = Math.floor(100000 + Math.random() * 900000).toString();\r\n\r\n    // Store in session (or Redis)\r\n    if (req.session) {\r\n      req.session.otp = otp;\r\n      req.session.otpCreatedAt = Date.now();\r\n      await req.session.save();\r\n    }\r\n\r\n    // TODO: Real SMS\r\n    console.log(`[OTP] FAN: ${fan} | Phone: ${phoneNumber} | OTP: ${otp}`);\r\n\r\n    const masked = phoneNumber.replace(/\\d(?=\\d{4})/g, '*');\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: 'OTP sent',\r\n      maskedPhone: masked,\r\n    });\r\n  } catch (err) {\r\n    if (err instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, errors: err.issues });\r\n    }\r\n    console.error('sendOtp error:', err);\r\n    res.status(500).json({ success: false, message: 'Failed to send OTP' });\r\n  }\r\n};\r\n\r\n// ────────────────────────────────────────────────\r\n// 3. Verify OTP\r\n// ────────────────────────────────────────────────\r\n\r\nexport const verifyOtp = async (req: Request, res: Response) => {\r\n  try {\r\n    const { fan, otp } = otpVerifySchema.parse(req.body);\r\n\r\n    if (!req.session?.otp || !req.session?.otpCreatedAt) {\r\n      return res.status(400).json({ success: false, message: 'No OTP request found' });\r\n    }\r\n\r\n    if (Date.now() - req.session.otpCreatedAt > 10 * 60 * 1000) {\r\n      return res.status(410).json({ success: false, message: 'OTP expired' });\r\n    }\r\n\r\n    if (req.session.otp !== otp) {\r\n      return res.status(400).json({ success: false, message: 'Invalid OTP' });\r\n    }\r\n\r\n    // Success\r\n    req.session.otp = undefined;\r\n    req.session.otpCreatedAt = undefined;\r\n\r\n    await Harmonization.findOneAndUpdate(\r\n      { fan },\r\n      { fan, method: 'OTP', status: 'VERIFIED', verifiedAt: new Date() },\r\n      { upsert: true }\r\n    );\r\n\r\n    await req.session.save();\r\n\r\n    res.status(200).json({ success: true, message: 'OTP verified' });\r\n  } catch (err) {\r\n    if (err instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, errors: err.issues });\r\n    }\r\n    console.error('verifyOtp error:', err);\r\n    res.status(500).json({ success: false, message: 'Server error' });\r\n  }\r\n};\r\n\r\n// ────────────────────────────────────────────────\r\n// 4. Verify Face (mock for now)\r\n// ────────────────────────────────────────────────\r\n\r\nexport const verifyFace = async (req: Request, res: Response) => {\r\n  try {\r\n    const { fan, faceImage, accounts } = faceVerifySchema.parse(req.body);\r\n\r\n    // TODO: Real face match against Fayda\r\n    const matchScore = 0.92; // mock\r\n\r\n    if (matchScore < 0.85) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Face verification failed – low match score',\r\n        matchScore,\r\n      });\r\n    }\r\n\r\n    await Harmonization.findOneAndUpdate(\r\n      { fan },\r\n      {\r\n        fan,\r\n        method: 'FACE',\r\n        status: 'VERIFIED',\r\n        verifiedAt: new Date(),\r\n        accounts: accounts || [],\r\n        matchScore,\r\n      },\r\n      { upsert: true }\r\n    );\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: 'Face verified',\r\n      matchScore,\r\n    });\r\n  } catch (err) {\r\n    if (err instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, errors: err.issues });\r\n    }\r\n    console.error('verifyFace error:', err);\r\n    res.status(500).json({ success: false, message: 'Server error' });\r\n  }\r\n};\r\n\r\n// ────────────────────────────────────────────────\r\n// 5. Link Accounts (final step)\r\n// ────────────────────────────────────────────────\r\n\r\nexport const linkAccounts = async (req: Request, res: Response) => {\r\n  try {\r\n    const { fan, accounts } = linkAccountsSchema.parse(req.body);\r\n\r\n    if (!req.session?.accountNumber) {\r\n      return res.status(403).json({ success: false, message: 'Session invalid' });\r\n    }\r\n\r\n    const accountNumber = req.session.accountNumber;\r\n\r\n    await Harmonization.findOneAndUpdate(\r\n      { fan },\r\n      {\r\n        status: 'COMPLETED',\r\n        accounts,\r\n        harmonizedAt: new Date(),\r\n      },\r\n      { upsert: true }\r\n    );\r\n\r\n    // TODO: Update User model if needed\r\n    // await User.findOneAndUpdate({ accountNumber }, { isHarmonized: true });\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: 'Accounts linked successfully',\r\n    });\r\n  } catch (err) {\r\n    if (err instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, errors: err.issues });\r\n    }\r\n    console.error('linkAccounts error:', err);\r\n    res.status(500).json({ success: false, message: 'Server error' });\r\n  }\r\n};"]}